From f5a7225caa168641a668e979f8ae5098f39d5ad0 Mon Sep 17 00:00:00 2001
From: John Crispin <john@phrozen.org>
Date: Mon, 23 Nov 2020 10:57:45 +0100
Subject: [PATCH] ipq807x: update to ath11k-ed2 release

Signed-off-by: John Crispin <john@phrozen.org>
---
 include/kernel-version.mk                            |  2 +-
 target/linux/ipq807x/Makefile                        |  2 +-
 .../etc/hotplug.d/firmware/10-ath11k-caldata         |  4 ++--
 target/linux/ipq807x/config-4.4                      |  2 ++
 target/linux/ipq807x/patches/107-ed2-compile.patch   | 12 ++++++++++++
 5 files changed, 18 insertions(+), 4 deletions(-)
 create mode 100644 target/linux/ipq807x/patches/107-ed2-compile.patch

diff --git a/include/kernel-version.mk b/include/kernel-version.mk
index 43bdf76db7..52c249ff9f 100644
--- a/include/kernel-version.mk
+++ b/include/kernel-version.mk
@@ -9,7 +9,7 @@ endif
 LINUX_VERSION-4.4 = .60
 LINUX_VERSION-4.14 = .187
 
-LINUX_KERNEL_HASH-4.4.60 = 92c5320788332fedbfe8ce2da80a849dd68d1e7eeb09a094b93d1ae05a69ef89
+LINUX_KERNEL_HASH-4.4.60 = 2cd8df6f1ac6a5329c5a286ec9b5956215977221a1b731597ed169fff74a9659
 LINUX_KERNEL_HASH-4.14.187 = 5b223475eaeea196aa7e127d3f253bca5c35d8afdc72ca75230ce1ecdd1454bd
 
 remove_uri_prefix=$(subst git://,,$(subst http://,,$(subst https://,,$(1))))
diff --git a/target/linux/ipq807x/Makefile b/target/linux/ipq807x/Makefile
index d1d6e0e6fc..0895fec121 100644
--- a/target/linux/ipq807x/Makefile
+++ b/target/linux/ipq807x/Makefile
@@ -9,7 +9,7 @@ KERNELNAME:=Image dtbs
 CPU_TYPE:=cortex-a53
 
 KERNEL_PATCHVER:=4.4
-KERNEL_NAME_SUFFIX=-qsdk-ad8f8efb2edcd35cdb130466cfc1923c37ef7ec1
+KERNEL_NAME_SUFFIX=-qsdk-10fd7d14853b7020b804acae690c8acec5d954ce
 
 include $(INCLUDE_DIR)/target.mk
 DEFAULT_PACKAGES += kmod-qca-nss-dp kmod-qca-ssdk swconfig \
diff --git a/target/linux/ipq807x/base-files/etc/hotplug.d/firmware/10-ath11k-caldata b/target/linux/ipq807x/base-files/etc/hotplug.d/firmware/10-ath11k-caldata
index 6004e8b88d..80f00c1cb4 100755
--- a/target/linux/ipq807x/base-files/etc/hotplug.d/firmware/10-ath11k-caldata
+++ b/target/linux/ipq807x/base-files/etc/hotplug.d/firmware/10-ath11k-caldata
@@ -26,7 +26,7 @@ caldata_extract() {
 board=$(board_name)
 
 case "$FIRMWARE" in
-"IPQ8074/caldata.bin")
+"ath11k/IPQ8074/hw2.0/caldata.bin")
 	case "$board" in
 	cig,wf194c|\
 	edgecore,eap102 |\
@@ -37,7 +37,7 @@ case "$FIRMWARE" in
 		;;
 	esac
 	;;
-"IPQ6018/caldata.bin")
+"ath11k/IPQ6018/hw1.0/caldata.bin")
 	case "$board" in
 	cig,wf188|\
 	cig,wf188n|\
diff --git a/target/linux/ipq807x/config-4.4 b/target/linux/ipq807x/config-4.4
index 84e68078a6..b7e0491f45 100644
--- a/target/linux/ipq807x/config-4.4
+++ b/target/linux/ipq807x/config-4.4
@@ -640,6 +640,7 @@ CONFIG_UNINLINE_SPIN_UNLOCK=y
 CONFIG_USB_GADGET=n
 CONFIG_USB_SUPPORT=y
 # CONFIG_USB_DWC3_OF_SIMPLE is not set
+# CONFIG_USB_QCOM_KS_BRIDGE is not set
 # CONFIG_USB_QCOM_8X16_PHY is not set
 # CONFIG_USB_QCOM_QUSB_PHY is not set
 # CONFIG_USB_QCOM_QMP_PHY is not set
@@ -743,3 +744,4 @@ CONFIG_CRYPTO_MICHAEL_MIC=y
 # CONFIG_MAP_E_SUPPORT is not set
 # CONFIG_USB_QCA_M31_PHY is not set
 CONFIG_QTI_Q6V5_ADSP=y
+# CONFIG_QGIC2_MSI is not set
diff --git a/target/linux/ipq807x/patches/107-ed2-compile.patch b/target/linux/ipq807x/patches/107-ed2-compile.patch
new file mode 100644
index 0000000000..8122f9ee7d
--- /dev/null
+++ b/target/linux/ipq807x/patches/107-ed2-compile.patch
@@ -0,0 +1,12 @@
+Index: linux-4.4.60-qsdk-10fd7d14853b7020b804acae690c8acec5d954ce/include/linux/qcom_scm.h
+===================================================================
+--- linux-4.4.60-qsdk-10fd7d14853b7020b804acae690c8acec5d954ce.orig/include/linux/qcom_scm.h
++++ linux-4.4.60-qsdk-10fd7d14853b7020b804acae690c8acec5d954ce/include/linux/qcom_scm.h
+@@ -14,6 +14,7 @@
+ #define __QCOM_SCM_H
+ 
+ #include <linux/scatterlist.h>
++#include <linux/device.h>
+ 
+ #define QCOM_KERNEL_AUTH_CMD		0x15
+ #define QCOM_SCM_PAS_AUTH_DEBUG_RESET_CMD	0x14
-- 
2.25.1

